---
title: 'Lullington Heath: a Long-term Monitoring Network report'
author: "Kieran Fox"
date: "15/02/2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
setwd('C:/Users/Kieran/Desktop/NE/NE_work')
source('./data_prep_figure4.R')

library(janitor)
```

This is an example of a report to send to site managers. It wouldn't need to have the author, its just added as default. When these reports are finalised, I will definitely make them more pretty, this is just to give you an idea of the content. This is an HTML report rather than PDF so that the maps can be a little interactive.

```{r import, include=FALSE}
name_gl <- get_names('rename_habitat.csv')
name_swap_vector <- name_gl[[1]]
bb_list <- name_gl[[2]]
bp_list <- name_gl[[3]]

df_all <- read_all_data('all_plots.csv')
# Taking the data from just one site
df_site <- filter(df_all, SITECODE == 'B14')
print(unique(df_site$BAP_BROAD))
print(unique(df_site$BAP_PRIORITY))
df_site <- fix_names(df_site)

# transform the eastings and northings into latitude and longitude
df_site <- transform_coords(df_site)

# Making the sub dataframes with only the major habitats selected
#object[[1]] is the data frame. object[[2]] is the list of habitats
df_site.bb <- select_by('BAP_BROAD', 20)
df_site.bp <- select_by('BAP_PRIORITY', 15)
df_site.nvcb <- select_by('NVC_groupb', 15)
df_site.nvcc <- select_by('NVC_groupc', 15)

# the centre points of the maps
centre_coords <- get_centre_coords(df_site)
east_cent <- centre_coords[[1]]
north_cent <- centre_coords[[2]]

unique_years <- unique(df_site$YEAR)
unique_habs <- unique(df_site$BAP_BROAD)
# these columns give inofrmation about the plot but aren't quantitatively comp
track_cols <- c('PLOT_ID', 'coords.easting', 'coords.northing', 'BAP_BROAD',
                'BAP_PRIORITY', 'NVC_groupb', 'NVC_groupc')
# these columns wil be compared between years
change_cols <- c('Species_richness', 'Species_diversity', 'LIGHT', 'WETNESS',
                 'PH', 'FERTILITY', 'COMPETITION', 'STRESS', 'RUDERALS',
                 'MEAN_HEIGHT', 'litter', 'bare.x')

total_change <- get_change_by_year(df_site)
```

# Describing the nvc habitats


```{r habitats_in_site}

df_count1 <- df_site[!is.na(df_site[ ,'BAP_BROAD']),] %>%
  group_by(YEAR) %>%
  dplyr::count(BAP_BROAD) %>%
  spread(YEAR, n) %>%
  adorn_totals("row")

print(df_count1)

df_count2 <- df_site[!is.na(df_site[ ,'NVC_groupc']),] %>%
  group_by(YEAR) %>%
  dplyr::count(NVC_groupc) %>%
  spread(YEAR, n) %>%
  adorn_totals("row")

print(df_count2)
```

This is just to give a simple overview of the habitats in the site. I will obviously look to make these tables look a lot nicer in the final reports.

```{r habitats_in_site9}
# Showing the proportion of each NVC group in each bap habitat
# with years next to each other showing change
habitat_by_habitat('NVC_groupc', 'NVC_groupb')
```
The calcaerous grassland plot could be interesting. There seems to be an increase in good quality CG2 habitat. Lets see if this trend plays out in the rest of the data.


# Describing the species richness and diversity

```{r change_by_year4}
plot_feat_by_hab_year('NVC_groupc', 'Species_richness')
```
This shows the change in species richness by year, separated by the NVC habitat. This could instead easily be separated by the BAP broad habitat. We can see different trends in the different habitats here. It could be that on particular sites, only certin habitats are of interest. In this case, Lullington is important for its chalk grassland and heath so we could potentially remove the other habitats.


```{r map_feature_by_hab2}
map_feature_by_hab(df_site, 'NVC_groupc', 'Species_richness')
```

This figure shows the habitat by colour and species richness by circle radius. This particular figure is of the most recent 2018 survey. We can include previous surveys in there as well.

We can see that there are a lot of different habitats which might make this a little hard to read. I can only inlcude plots from important habitats, or we can use BAP broad to classify instead of NVC

```{r map_feature_by_hab3}
map_feature_by_hab(df_site, 'BAP_BROAD', 'Species_richness')
```
This might be a bit more informative. We can see here how important the work Sarah is doing to fill in the BAP broad habitat classifications is.

```{r map_change2}
map_change('Species_richness', norm=FALSE)
```
This shows the change in the last survey. The most striking thing to me here is the change on the east side of the site. There might only be a slight decrease in richness here but I know that this part of the site is supposed to be the best quality chalk grassland. In contrast, the heathland in the centre of the plot seems to be increaseing in species richness.

# Ellenberg and grimes

This section will be to see how ellenberg and grimes scores have changed and if there is a spatial relationship to the change. We can remove these difures for any particular score if there is no change and we can remove just the map figures if the change is not spatially related

### Fertility change by year
```{r change_by_year}
plot_feat_by_hab_year('NVC_groupc', 'FERTILITY')
```

Another example where reducing the number of habitats might be useful. 

### Fertility across the site
```{r map_feature3}
map_feature(df_site, 'FERTILITY')
```

This figure shows there is a slight spatial relationship to fertility across the site. It might be interesting to the site manager. We can see there that the west side of the site is much more fertile and so might not be considerred as important when deciding which areas of the site to prioritise management as it has much less potential. (Of course the site manager might think otherwise but eitherway this plot seems really useful to them).

### Fertility change across the site
```{r map_change6}
map_change('FERTILITY', norm=FALSE, year_sel=2)
```
This is a figure of change between 2010 and 2014. There are a number of areas which seem to be changing.

```{r map_change7}
map_change('FERTILITY', norm=FALSE, year_sel=3)
```

This is a figure of the change between 2014 and 2017. This seems particularly distinct. There is a clear increase in fertility on the east side of the site in the most recent survey. (Oh, it should be worth noting that I am most of the way towards flipping that legend that is upside-down. Its more difficult that you would think haha).


### Litter and bare ground change by year
```{r change_by_year99}
plot_feat_by_hab_year('NVC_groupc', 'litter')


plot_feat_by_hab_year('NVC_groupc', 'bare.x')

```

These are probaby two features that could be displayed side by side so I will make a figure for that for each habitat. However, we can see here that the litter was not particularly wel recorded in the early surveys at Lullington so in this case we might omit this figure.

Here are a list of the other features we can display

```{r list_of_names}
print(names(df_site))

```