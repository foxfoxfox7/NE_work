---
title: 'Bure Marshes: a Long-term Monitoring Network report'
author: "Kieran Fox"
date: "15/02/2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
setwd('C:/Users/Kieran/Desktop/NE/NE_work')
source('./data_prep_figure4.R')

library(janitor)
```

This is an example of a report to send to site managers. It wouldn't need to have the author, its just added as default. When these reports are finalised, I will definitely make them more pretty, this is just to give you an idea of the content. This is an HTML report rather than PDF so that the maps can be a little interactive.

```{r import, include=FALSE}
name_gl <- get_names('rename_habitat.csv')
name_swap_vector <- name_gl[[1]]
bb_list <- name_gl[[2]]
bp_list <- name_gl[[3]]

df_all <- read_all_data('all_plots.csv')
# Taking the data from just one site
df_site <- filter(df_all, SITECODE == 'B02')
print(unique(df_site$BAP_BROAD))
print(unique(df_site$BAP_PRIORITY))
df_site <- fix_names(df_site)

# transform the eastings and northings into latitude and longitude
df_site <- transform_coords(df_site)

# Making the sub dataframes with only the major habitats selected
#object[[1]] is the data frame. object[[2]] is the list of habitats
df_site.bb <- select_by('BAP_BROAD', 20)
df_site.bp <- select_by('BAP_PRIORITY', 15)
df_site.nvcb <- select_by('NVC_groupb', 15)
df_site.nvcc <- select_by('NVC_groupc', 15)

# the centre points of the maps
centre_coords <- get_centre_coords(df_site)
east_cent <- centre_coords[[1]]
north_cent <- centre_coords[[2]]

unique_years <- unique(df_site$YEAR)
unique_habs <- unique(df_site$BAP_BROAD)
# these columns give inofrmation about the plot but aren't quantitatively comp
track_cols <- c('PLOT_ID', 'coords.easting', 'coords.northing', 'BAP_BROAD',
                'BAP_PRIORITY', 'NVC_groupb', 'NVC_groupc')
# these columns wil be compared between years
change_cols <- c('Species_richness', 'Species_diversity', 'LIGHT', 'WETNESS',
                 'PH', 'FERTILITY', 'COMPETITION', 'STRESS', 'RUDERALS',
                 'MEAN_HEIGHT', 'litter', 'bare.x')

total_change <- get_change_by_year(df_site)
```

# Describing the nvc habitats

```{r habitats_in_site}

df_count1 <- df_site[!is.na(df_site[ ,'BAP_BROAD']),] %>%
  group_by(YEAR) %>%
  dplyr::count(BAP_BROAD) %>%
  spread(YEAR, n) %>%
  adorn_totals("row")

print(df_count1)

df_count2 <- df_site[!is.na(df_site[ ,'NVC_groupc']),] %>%
  group_by(YEAR) %>%
  dplyr::count(NVC_groupc) %>%
  spread(YEAR, n) %>%
  adorn_totals("row")

print(df_count2)
```

This is just to give a simple overview of the habitats in the site. I will obviously look to make these tables look a lot nicer in the final reports.

```{r habitats_in_site9}
# Showing the proportion of each NVC group in each bap habitat
# with years next to each other showing change
habitat_by_habitat('NVC_groupc', 'NVC_groupb')
```
This shows the proportion of each specific nvc habitat in the broader habitats. in these case we can see no interesting information and so we would likely remove these. There are examples of sites where there is a clear change in the proportion of the more specific nvc habitats and as these designations often give an indication of habitat quality those could be useful. For example CG2 is much higher quality grassland than CG6


# Describing the species richness and diversity

```{r change_by_year4}
plot_feat_by_hab_year('NVC_groupc', 'Species_richness')
```
This shows the change in species richness by year, separated by the NVC habitat. This could instead easily be separated by the BAP broad habitat. We can see a very clear increasing trend in both major habitats. The middle line of the box is the average (median) and the box itself shows the range. We can see there is a greater rane of values in the S habitat.


```{r map_feature_by_hab2}
map_feature_by_hab(df_site, 'NVC_groupc', 'Species_richness')
```

This figure shows the habitat by colour and species richness by circle radius. This particular figure is of the most recent 2018 survey. We can include previous surveys in there as well.

Something I would really like to do is have maps that can switch between plotting two different features. In this case, switching between species richness and species diversity would be ideal. I'm actually not sure if this is possible. I will look into it. therwise we would just have two different plots.

```{r map_feature_by_hab3}
map_feature_by_hab(df_site, 'BAP_BROAD', 'Species_richness')
```
the same map can be shown using BAP BROAD habitats as well. Probably we would decide which is the most informative

```{r map_change2}
map_change('Species_richness', norm=FALSE)
```
This shows the change in the last survey. There is not a huge spatial relationship in the change in species richness but to me it appears there might be a slight concentrated increase in the centre of the site. We would need to decide if we wanted to include this figure.

# Ellenberg and grimes

This section will be to see how ellenberg and grimes scores have changed and if there is a spatial relationship to the change. We can remove these difures for any particular score if there is no change and we can remove just the map figures if the change is not spatially related

### Fertility change by year
```{r change_by_year}
plot_feat_by_hab_year('NVC_groupc', 'FERTILITY')
```

In this example we can see a definite decrease in fertility between 2010 and 2014 which suggests we should keep this figure

### Fertility across the site
```{r map_feature3}
map_feature(df_site, 'FERTILITY')
```

This figure shows there is a slight spatial relationship to fertility across the site. It might be interesting to the site manager

### Fertility change across the site
```{r map_change6}
map_change('FERTILITY', norm=FALSE, year_sel=2)
```
This is a figure of change between 2010 and 2014. It looks like a particular reduction of fertility in the center of the site. This could be related to the change in species richness in that same area. (It is worth baring in mind that these ellenberg scores are in part calculated from the species richness value so this can explain the relationship. More detailed soil data would be needed to investigate if there is a real cause and effect relationship).

```{r map_change7}
map_change('FERTILITY', norm=FALSE, year_sel=3)
```

This is a figure of the change between 2014 and 2018. We already knew that there wasn't really any change and with this figure we can see that that's true across the whole site. I would consider removing this figure in the final report.

